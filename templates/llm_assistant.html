{% extends 'base.html' %}

{% block title %}LLM Assistant - AI Assistant Platform{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 70vh;
        overflow-y: auto;
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: rgba(33, 37, 41, 0.5);
    }
    
    .message {
        margin-bottom: 1rem;
        max-width: 80%;
    }
    
    .user-message {
        margin-left: auto;
        background-color: #0d6efd;
        color: white;
        border-radius: 1rem 1rem 0 1rem;
        padding: 0.75rem 1rem;
    }
    
    .assistant-message {
        margin-right: auto;
        background-color: #2a2d35;
        border-radius: 1rem 1rem 1rem 0;
        padding: 0.75rem 1rem;
    }
    
    .system-message {
        margin: 1rem auto;
        background-color: #212529;
        color: #6c757d;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        font-style: italic;
        font-size: 0.9rem;
        text-align: center;
        max-width: 90%;
    }
    
    .conversation-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .conversation-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .conversation-item.active {
        background-color: rgba(13, 110, 253, 0.2);
        border-left: 3px solid #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h1>LLM Assistant</h1>
            <p class="lead">Chat with the local AI assistant using PostgreSQL for conversation history</p>
        </div>
    </div>

    <div class="row">
        <!-- Conversation List -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Conversations</h5>
                    <button class="btn btn-sm btn-primary" id="new-conversation-btn">
                        <i class="bi bi-plus"></i> New
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush conversation-list">
                        {% if conversations %}
                            {% for conv in conversations %}
                            <div class="list-group-item conversation-item d-flex justify-content-between align-items-start" data-id="{{ conv.id }}">
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold">{{ conv.title or 'Conversation ' ~ conv.id }}</div>
                                    <small>{{ conv.message_count or 0 }} messages</small>
                                </div>
                                <small>{{ conv.updated_at.strftime('%Y-%m-%d') if conv.updated_at else 'N/A' }}</small>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="list-group-item text-center py-4">
                                <p class="text-muted">No conversations yet</p>
                                <p>Start a new conversation!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0" id="current-conversation-title">Select or start a conversation</h5>
                </div>
                <div class="card-body">
                    <div class="chat-container" id="chat-container">
                        <!-- Messages will be loaded here -->
                        <div class="system-message">
                            <p>Start a new conversation or select an existing one.</p>
                        </div>
                    </div>
                    
                    <form id="message-form" class="mt-3">
                        <div class="input-group">
                            <input type="text" id="message-input" class="form-control" placeholder="Type your message..." disabled>
                            <button type="submit" class="btn btn-primary" id="send-button" disabled>
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentConversationId = null;

// Helper to create message elements
function createMessageElement(content, role) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}-message`;
    messageDiv.textContent = content;
    return messageDiv;
}

// Load a conversation
function loadConversation(conversationId) {
    // Clear current chat
    const chatContainer = document.getElementById('chat-container');
    chatContainer.innerHTML = '';
    
    // Update UI
    document.getElementById('message-input').disabled = false;
    document.getElementById('send-button').disabled = false;
    
    // Update active conversation
    const conversationItems = document.querySelectorAll('.conversation-item');
    conversationItems.forEach(item => {
        item.classList.remove('active');
        if (item.dataset.id == conversationId) {
            item.classList.add('active');
            document.getElementById('current-conversation-title').textContent = 
                item.querySelector('.fw-bold').textContent;
        }
    });
    
    // Set current conversation
    currentConversationId = conversationId;
    
    // Fetch messages
    fetch(`/llm_assistant/conversation/${conversationId}`)
        .then(response => response.json())
        .then(data => {
            // Add messages to chat
            data.messages.forEach(msg => {
                chatContainer.appendChild(createMessageElement(msg.content, msg.role));
            });
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        })
        .catch(error => {
            console.error('Error fetching conversation:', error);
            chatContainer.innerHTML = '<div class="system-message">Error loading conversation.</div>';
        });
}

// Create a new conversation
function createNewConversation() {
    fetch('/llm_assistant/new_conversation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Refresh the page to show the new conversation
        window.location.reload();
    })
    .catch(error => {
        console.error('Error creating conversation:', error);
    });
}

// Send a message
function sendMessage(message) {
    if (!currentConversationId || !message.trim()) return;
    
    // Add user message to chat
    const chatContainer = document.getElementById('chat-container');
    chatContainer.appendChild(createMessageElement(message, 'user'));
    
    // Clear input
    document.getElementById('message-input').value = '';
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // Show typing indicator
    const typingIndicator = document.createElement('div');
    typingIndicator.className = 'message assistant-message';
    typingIndicator.innerHTML = '<span class="typing-indicator">...</span>';
    chatContainer.appendChild(typingIndicator);
    
    // Send to server
    fetch('/llm_assistant/message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            conversation_id: currentConversationId,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        // Remove typing indicator
        chatContainer.removeChild(typingIndicator);
        
        // Add assistant response
        chatContainer.appendChild(createMessageElement(data.response, 'assistant'));
        
        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
    })
    .catch(error => {
        console.error('Error sending message:', error);
        
        // Remove typing indicator
        chatContainer.removeChild(typingIndicator);
        
        // Show error
        const errorMessage = document.createElement('div');
        errorMessage.className = 'system-message';
        errorMessage.textContent = 'Error sending message. Please try again.';
        chatContainer.appendChild(errorMessage);
        
        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
    });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // New conversation button
    document.getElementById('new-conversation-btn').addEventListener('click', createNewConversation);
    
    // Conversation items
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.addEventListener('click', function() {
            loadConversation(this.dataset.id);
        });
    });
    
    // Message form
    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        if (message) {
            sendMessage(message);
        }
    });
});
</script>
{% endblock %}